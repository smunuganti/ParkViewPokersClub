<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    
    <!-- iOS / Android Standalone App Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Poker Club">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#020617">
    
    <!-- App Icon (Fluent Emoji Fireworks) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23020617%22/><text y=%22.9em%22 font-size=%2280%22 x=%2210%22>ðŸŽ†</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ†</text></svg>">

    <!-- Web App Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlBhcmsgVmlldyBQb2tlcnMgQ2x1YiIsCiAgInNob3J0X25hbWUiOiAiUG9rZXIgQ2x1YiIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDIwNjE3IiwKICAidGhlbWVfY29sb3IiOiAiIzAyMDYxNyIKfQ==">

    <title>Park View Pokers Club - 2026</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Ecosystem -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        .animate-confetti {
            animation: confetti-fall linear infinite;
        }
        
        /* Layout & Scrolling */
        ::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { display: block; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 10px; opacity: 0.3; }
        
        body {
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            user-select: none;
            background-color: #020617;
            /* Prevent accidental refresh/bounce on mobile */
            overscroll-behavior: none;
            height: 100vh;
            width: 100vw;
        }
        
        /* Modern Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .btn-active:active {
            transform: scale(0.96);
        }

        .gold-glow {
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        }

        input {
            user-select: text;
        }
        
        /* iOS Notch Spacing */
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        /**
         * Enhanced Icon component. 
         * Manages its own lifecycle to prevent React reconciliation conflicts with external DOM manipulation libraries.
         */
        const Icon = ({ name, size = 20, className = "", strokeWidth = 2, fill = "none" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && window.lucide) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}" style="width: ${size}px; height: ${size}px;" stroke-width="${strokeWidth}" fill="${fill}"></i>`;
                    window.lucide.createIcons({ targets: [containerRef.current] });
                }
            }, [name, size, strokeWidth, fill]);
            return <span ref={containerRef} className={`inline-flex items-center justify-center shrink-0 ${className}`} style={{ width: size, height: size }}></span>;
        };

        // --- System Logic ---
        const STORAGE_VER = "v151_hosting_ready"; 
        const STORAGE_KEY = `pvp_club_ledger_${STORAGE_VER}`;
        const THEME_KEY = `pvp_theme_${STORAGE_VER}`;
        const DEFAULT_ROSTER = ['Player 1', 'Player 2', 'Player 3'];

        const App = () => {
            const [showWelcome, setShowWelcome] = useState(true);
            const [isDarkMode, setIsDarkMode] = useState(() => {
                try { return localStorage.getItem(THEME_KEY) !== 'light'; } catch(e) { return true; }
            });

            // --- Game State Engine ---
            const [game, setGame] = useState(() => {
                try {
                    const data = localStorage.getItem(STORAGE_KEY);
                    if (data) {
                        const parsed = JSON.parse(data);
                        if (parsed && Array.isArray(parsed.players)) return parsed;
                    }
                } catch(e) {}
                return { 
                    players: DEFAULT_ROSTER, 
                    rounds: [], 
                    history: [], 
                    inactive: [],
                    reEntries: new Array(DEFAULT_ROSTER.length).fill(0)
                };
            });

            const [isAddingRound, setIsAddingRound] = useState(false);
            const [editingRoundIdx, setEditingRoundIdx] = useState(null); 
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);
            const [bustedOverlay, setBustedOverlay] = useState(null); 
            const [confirmModal, setConfirmModal] = useState(null); 
            const [newScores, setNewScores] = useState({});
            const [newPlayerName, setNewPlayerName] = useState('');
            const [editIdx, setEditIdx] = useState(null);
            const [editValue, setEditValue] = useState('');
            const [error, setError] = useState(null);
            const [shareFeedback, setShareFeedback] = useState(false);
            
            const scrollRef = useRef(null);

            // --- Calculations ---
            const players = game.players;
            const rounds = game.rounds;
            const inactive = game.inactive || [];
            const reEntries = game.reEntries || new Array(players.length).fill(0);
            const sessionHistory = game.history || [];

            const getPlayerName = (idx) => {
                const p = players[idx];
                if (!p) return "Unknown";
                return typeof p === 'object' ? (p.name || `Player ${idx + 1}`) : p;
            };

            const totals = useMemo(() => {
                return players.map((_, pIdx) => 
                    rounds.reduce((sum, r) => sum + (Array.isArray(r) ? (r[pIdx] || 0) : 0), 0)
                );
            }, [players, rounds]);

            const activeCount = players.length - inactive.length;
            const matchOver = activeCount <= 1 && rounds.length > 0;

            const minTotal = useMemo(() => {
                const activeTotals = totals.filter((_, i) => !inactive.includes(i));
                return activeTotals.length > 0 ? Math.min(...activeTotals) : 0;
            }, [totals, inactive]);

            const leaderIdx = useMemo(() => {
                if (rounds.length === 0) return -1;
                return totals.findIndex((t, i) => !inactive.includes(i) && t === minTotal);
            }, [totals, inactive, minTotal, rounds]);

            const canRejoin = useMemo(() => {
                if (!bustedOverlay) return false;
                const others = bustedOverlay.projected.filter((_, i) => i !== bustedOverlay.currentIdx && !inactive.includes(i));
                return !others.some(t => t >= 180);
            }, [bustedOverlay, inactive]);

            // --- Persistence ---
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(game));
                localStorage.setItem(THEME_KEY, isDarkMode ? 'dark' : 'light');
                if (!isAddingRound && !editingRoundIdx && scrollRef.current && game.rounds.length > 0) {
                    scrollRef.current.scrollTo({ top: scrollRef.current.scrollHeight, behavior: 'smooth' });
                }
            }, [game, isDarkMode, isAddingRound, editingRoundIdx]);

            // --- Functional Logic ---
            const handleScoreEntry = (isEdit = false) => {
                setError(null);
                const entry = players.map((p, i) => {
                    if (inactive.includes(i)) return 0;
                    const pName = typeof p === 'object' ? p.name : p;
                    const v = newScores[pName];
                    return (v === "" || v === undefined) ? null : parseInt(v);
                });

                if (entry.some((s, i) => !inactive.includes(i) && (s === null || isNaN(s)))) {
                    setError("Score required for all active players.");
                    return;
                }
                
                const activeScores = entry.filter((_, i) => !inactive.includes(i));
                if (activeScores.filter(s => s === 0).length !== 1) {
                    setError("Exactly one player must win the hand (score 0).");
                    return;
                }

                if (isEdit) {
                    const updatedRounds = [...rounds];
                    updatedRounds[editingRoundIdx] = entry;
                    setGame(prev => ({ ...prev, rounds: updatedRounds }));
                    setEditingRoundIdx(null);
                    setNewScores({});
                    return;
                }

                const projected = totals.map((t, i) => t + (entry[i] || 0));
                const bustedIdxs = projected.map((t, i) => (!inactive.includes(i) && t > 201) ? i : -1).filter(i => i !== -1);

                if (bustedIdxs.length > 0) {
                    const safePlayers = projected.filter((t, i) => !bustedIdxs.includes(i) && !inactive.includes(i));
                    const target = (safePlayers.length > 0 ? Math.max(...safePlayers) : 0) + 1;
                    setBustedOverlay({ indices: bustedIdxs, currentIdx: bustedIdxs[0], target, pending: entry, projected });
                } else {
                    saveHand(entry);
                }
            };

            const saveHand = (scores) => {
                setGame(prev => ({ ...prev, rounds: [...prev.rounds, scores] }));
                setNewScores({});
                setIsAddingRound(false);
                setBustedOverlay(null);
            };

            const handleBustChoice = (rejoin) => {
                const scores = [...bustedOverlay.pending];
                const pIdx = bustedOverlay.currentIdx;
                const others = bustedOverlay.projected.filter((_, idx) => idx !== pIdx && !inactive.includes(idx));
                const isDoorClosed = others.some(t => t >= 180);

                let updatedInactive = [...inactive];
                let updatedReEntries = [...reEntries];

                if (rejoin && !isDoorClosed) {
                    scores[pIdx] = bustedOverlay.target - totals[pIdx];
                    updatedReEntries[pIdx] = (updatedReEntries[pIdx] || 0) + 1;
                } else {
                    if (!updatedInactive.includes(pIdx)) updatedInactive.push(pIdx);
                }

                const nextIdxs = bustedOverlay.indices.filter(i => i !== pIdx);
                if (nextIdxs.length === 0) {
                    setGame(prev => ({ ...prev, inactive: updatedInactive, reEntries: updatedReEntries }));
                    saveHand(scores);
                } else {
                    setBustedOverlay({ ...bustedOverlay, currentIdx: nextIdxs[0], indices: nextIdxs, pending: scores });
                    setGame(prev => ({ ...prev, inactive: updatedInactive, reEntries: updatedReEntries }));
                }
            };

            const addPlayer = (midGame = false) => {
                const name = newPlayerName.trim();
                if (!name || players.length >= 7) return;

                if (midGame && rounds.length > 0) {
                    const activeTotals = totals.filter((_, i) => !inactive.includes(i));
                    const activeHighest = activeTotals.length > 0 ? Math.max(...activeTotals) : Math.max(...totals);
                    const joinScore = activeHighest + 1;
                    
                    setGame(prev => ({
                        ...prev,
                        players: [...prev.players, name],
                        rounds: prev.rounds.map((r, i) => i === 0 ? [...r, joinScore] : [...r, 0]),
                        reEntries: [...(prev.reEntries || new Array(prev.players.length).fill(0)), 0]
                    }));
                    setNewPlayerName('');
                } else {
                    if (rounds.length > 0) {
                        setConfirmModal({
                            message: "Roster changes reset current scores. Proceed?",
                            onConfirm: () => {
                                setGame(p => ({ 
                                    ...p, players: [...p.players, name], rounds: [], inactive: [], 
                                    reEntries: new Array(p.players.length + 1).fill(0) 
                                }));
                                setNewPlayerName('');
                                setConfirmModal(null);
                            }
                        });
                    } else {
                        setGame(p => ({ 
                            ...p, players: [...p.players, name], rounds: [], inactive: [], 
                            reEntries: new Array(p.players.length + 1).fill(0) 
                        }));
                        setNewPlayerName('');
                    }
                }
            };

            const removePlayer = (idx) => {
                if (players.length <= 2) return;
                setConfirmModal({
                    message: `Expel ${getPlayerName(idx)}? All scores will reset.`,
                    onConfirm: () => {
                        setGame(s => ({ ...s, players: s.players.filter((_, i) => i !== idx), rounds: [], inactive: [], reEntries: [] }));
                        setConfirmModal(null);
                    }
                });
            };

            const savePlayerNameEdit = (idx) => {
                if (!editValue.trim()) return;
                const updatedPlayers = [...players];
                updatedPlayers[idx] = editValue.trim();
                setGame(prev => ({ ...prev, players: updatedPlayers }));
                setEditIdx(null);
                setEditValue('');
            };

            const startNewMatch = () => {
                const isBoardEmpty = rounds.length === 0;
                setConfirmModal({
                    message: isBoardEmpty ? "Reset current totals to 0?" : "Archive match and reset all scores to 0?",
                    onConfirm: () => {
                        const sessionSummary = {
                            id: Date.now(),
                            date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                            players: players.map((_, i) => getPlayerName(i)),
                            finalScores: [...totals],
                            reEntries: [...reEntries]
                        };

                        setGame(prev => ({
                            ...prev, 
                            rounds: [], 
                            inactive: [], 
                            reEntries: new Array(prev.players.length).fill(0),
                            history: [sessionSummary, ...(prev.history || [])].slice(0, 5)
                        }));
                        setConfirmModal(null);
                    }
                });
            };

            const shareStandings = async () => {
                const text = `ðŸŽ† Park View Pokers 2026 Standings ðŸŽ†\n\n` + 
                            players.map((_, i) => `${getPlayerName(i)}: ${totals[i]}${reEntries[i] > 0 ? ` (R${reEntries[i]})` : ''}${inactive.includes(i) ? ' (Out)' : ''}`).join('\n');
                if (navigator.share) {
                    try { await navigator.share({ title: '2026 Poker Scores', text }); } catch (err) {}
                } else {
                    const el = document.createElement('textarea');
                    el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                    setShareFeedback(true); setTimeout(() => setShareFeedback(false), 2000);
                }
            };

            // --- UI Elements ---
            const CelebrationOverlay = () => {
                const items = useMemo(() => Array.from({ length: 40 }).map((_, i) => ({
                    id: i, left: Math.random() * 100, delay: Math.random() * 5,
                    duration: 4 + Math.random() * 6, size: 2 + Math.random() * 3,
                    color: ['#f59e0b', '#fbbf24', '#ffffff', '#818cf8'][Math.floor(Math.random() * 4)]
                })), []);
                return (
                    <div className="fixed inset-0 pointer-events-none overflow-hidden z-50">
                        {items.map(p => (
                            <div key={`confetti-${p.id}`} className="absolute top-[-10px] rounded-sm animate-confetti"
                                style={{ left: `${p.left}%`, width: `${p.size}px`, height: `${p.size}px`, backgroundColor: p.color, animationDuration: `${p.duration}s`, animationDelay: `${p.delay}s` }}
                            />
                        ))}
                    </div>
                );
            };

            const WelcomeVisual = () => (
                <div className="relative w-48 h-48 mx-auto mb-8 pointer-events-none">
                    <div className="absolute inset-0 flex items-center justify-center animate-pulse opacity-20">
                        <Icon name="sparkles" size={180} className="text-yellow-500" />
                    </div>
                    <div className="absolute top-0 left-4 w-32 h-48 bg-slate-900 rounded-2xl shadow-xl border-2 border-yellow-500/40 transform -rotate-12 flex flex-col justify-between p-4 text-yellow-500">
                        <div className="text-left font-black leading-none text-lg">20<br/>26</div>
                        <div className="flex justify-center"><Icon name="spade" size={48} fill="currentColor" /></div>
                        <div className="text-right font-black leading-none rotate-180 text-lg">20<br/>26</div>
                    </div>
                    <div className="absolute top-2 right-4 w-32 h-48 bg-slate-800 rounded-2xl shadow-2xl border border-indigo-500/30 transform rotate-12 flex flex-col justify-between p-4 text-indigo-400">
                        <div className="text-left font-black leading-none opacity-40">A</div>
                        <div className="flex justify-center opacity-30"><Icon name="heart" size={48} fill="currentColor" /></div>
                        <div className="text-right font-black leading-none rotate-180 opacity-40">A</div>
                    </div>
                </div>
            );

            if (showWelcome) {
                return (
                    <div className="fixed inset-0 flex flex-col items-center justify-center p-8 transition-colors duration-500 bg-[#020617]">
                        <CelebrationOverlay />
                        <div className="max-w-sm w-full text-center relative z-10">
                            <div className="bg-gradient-to-r from-yellow-700 to-amber-400 text-black px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest mb-6 inline-block shadow-[0_0_25px_rgba(234,179,8,0.4)]">New Year 2026</div>
                            <WelcomeVisual />
                            <h1 className="text-3xl font-black uppercase italic text-yellow-500 mb-1 leading-none tracking-tighter gold-glow">Park View Pokers</h1>
                            <h2 className="text-5xl font-black uppercase tracking-widest mb-12 text-slate-400 leading-none">Club</h2>
                            <button onClick={() => setShowWelcome(false)} className="w-full h-16 bg-yellow-600 hover:bg-yellow-500 text-black rounded-3xl font-black uppercase tracking-widest shadow-2xl active:scale-95 transition-all flex items-center justify-center gap-3">
                                Start Session <Icon name="chevron-right" />
                            </button>
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className="mt-12 p-4 bg-white/5 border border-white/10 rounded-full hover:bg-white/10 transition-colors">
                                <Icon name={isDarkMode ? "sun" : "moon"} className="text-yellow-500" />
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`fixed inset-0 flex flex-col transition-colors duration-500 ${isDarkMode ? 'bg-[#020617]' : 'bg-white text-slate-900'}`}>
                    <CelebrationOverlay />
                    
                    <nav className={`flex-none px-4 py-4 z-40 pt-safe ${isDarkMode ? 'bg-slate-900/50 border-b border-white/10 backdrop-blur-md' : 'bg-white border-b border-slate-200'}`}>
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="w-10 h-10 bg-gradient-to-br from-yellow-700 to-amber-400 rounded-2xl flex items-center justify-center text-black shadow-lg"><Icon name="sparkles" /></div>
                                <div className="text-left leading-none">
                                    <h1 className="text-[11px] font-black uppercase text-yellow-500">Park View Pokers</h1>
                                    <span className="text-[9px] font-bold text-slate-400 uppercase opacity-60">2026 Session</span>
                                </div>
                            </div>
                            <div className="flex items-center gap-1">
                                <button onClick={startNewMatch} className="p-2 opacity-50 hover:text-yellow-500 transition-colors btn-active"><Icon name="rotate-ccw" /></button>
                                <button onClick={() => setIsHistoryOpen(true)} className="p-2 opacity-50 hover:text-indigo-400 transition-colors btn-active"><Icon name="history" /></button>
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 opacity-50 btn-active"><Icon name={isDarkMode ? "sun" : "moon"} /></button>
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 opacity-50 hover:text-yellow-500 transition-colors btn-active"><Icon name="settings-2" /></button>
                            </div>
                        </div>
                    </nav>

                    <div className="flex-1 flex flex-col overflow-hidden relative">
                        <div className={`flex-none flex border-b-2 z-20 ${isDarkMode ? 'bg-slate-950 border-white/5 shadow-xl' : 'bg-white border-slate-200'}`}>
                            <div className="w-10 text-[8px] font-black text-slate-500 uppercase flex items-center justify-center italic">Hand</div>
                            <div className="flex-1 flex">
                                {players.map((_, i) => (
                                    <div key={`header-p-${i}`} className={`flex-1 border-r last:border-r-0 py-3 text-center truncate ${inactive.includes(i) ? 'opacity-30 grayscale bg-black/5' : ''}`}>
                                        <div className="flex flex-col items-center justify-center gap-0.5 px-0.5">
                                            <span className="text-[10px] font-black uppercase truncate block w-full text-yellow-500/80 tracking-tight">{getPlayerName(i)}</span>
                                            {reEntries[i] > 0 && <span className="bg-indigo-600 text-white text-[6px] px-1 rounded-sm font-black leading-none py-1">R{reEntries[i]}</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div ref={scrollRef} className="flex-1 overflow-y-auto no-scrollbar custom-scrollbar bg-slate-900/5">
                            {rounds.map((round, rIdx) => (
                                <div key={`round-${rIdx}`} className="flex border-b border-white/5 transition-colors hover:bg-white/5">
                                    <div className="w-10 flex flex-col items-center justify-center py-4 gap-1">
                                        <span className="text-[10px] font-bold text-slate-500 italic">{rIdx + 1}</span>
                                        {rIdx >= rounds.length - 2 && (
                                            <button onClick={() => {
                                                setEditingRoundIdx(rIdx);
                                                const current = {};
                                                players.forEach((p, i) => current[getPlayerName(i)] = round[i]);
                                                setNewScores(current);
                                            }} className="text-indigo-500/40 hover:text-indigo-500 btn-active"><Icon name="pencil-line" size={12} /></button>
                                        )}
                                    </div>
                                    <div className="flex-1 flex">
                                        {round.map((score, cIdx) => (
                                            <div key={`score-${rIdx}-${cIdx}`} className={`flex-1 border-r last:border-r-0 flex items-center justify-center py-4 ${inactive.includes(cIdx) ? 'opacity-10' : ''}`}>
                                                {score === 0 ? (
                                                    <span className="w-7 h-7 rounded-full bg-yellow-600 text-black flex items-center justify-center text-[10px] font-black shadow-[0_0_10px_rgba(234,179,8,0.3)] border border-yellow-400/20">0</span>
                                                ) : (
                                                    <span className="text-sm font-bold tabular-nums text-slate-300">{score}</span>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                            {rounds.length === 0 && <div className="h-full flex flex-col items-center justify-center opacity-10 p-10 grayscale text-center select-none"><Icon name="party-popper" size={64} className="text-yellow-500" /><p className="text-xs font-black uppercase mt-4 tracking-widest italic text-yellow-500">Board Clear</p></div>}
                        </div>

                        <div className={`flex-none flex text-white shadow-[0_-10px_30px_rgba(0,0,0,0.5)] z-30 ${isDarkMode ? 'bg-slate-900 border-t border-white/5' : 'bg-slate-800'}`}>
                            <div className="w-10 text-[8px] font-black uppercase flex items-center justify-center bg-black/20 italic text-slate-500">Total</div>
                            <div className="flex-1 flex">
                                {totals.map((total, i) => (
                                    <div key={`total-p-${i}`} className={`flex-1 py-4 border-r last:border-r-0 border-white/5 text-center font-black text-lg ${inactive.includes(i) ? 'opacity-50 line-through' : ''}`}>
                                        <span className="flex items-center justify-center gap-1">
                                            {total} 
                                            {i === leaderIdx && !inactive.includes(i) && rounds.length > 0 && <Icon name="trophy" size={14} className="text-yellow-500" fill="#eab308" />}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="p-5 pb-safe flex-none border-t bg-slate-900 border-white/10">
                        {matchOver ? (
                            <div className="text-center p-2 animate-in zoom-in-95 duration-700">
                                <h4 className="text-xl font-black italic text-yellow-500 uppercase mb-3 gold-glow tracking-tight">{getPlayerName(leaderIdx)} Dominates!</h4>
                                <button onClick={startNewMatch} className="px-10 py-4 bg-indigo-600 text-white rounded-full text-xs font-black uppercase shadow-xl btn-active transition-all tracking-widest">New Match</button>
                            </div>
                        ) : (
                            <div className="flex gap-2 max-w-lg mx-auto">
                                <button onClick={() => setIsAddingRound(true)} className="flex-1 h-16 bg-yellow-600 text-black rounded-3xl font-black uppercase tracking-widest shadow-xl flex items-center justify-center gap-3 btn-active transition-all">
                                    <Icon name="plus" size={24} strokeWidth={3} /> Record Hand
                                </button>
                                <button onClick={shareStandings} className="px-6 h-16 bg-indigo-600 text-white rounded-2xl font-black shadow-xl flex items-center justify-center btn-active transition-all">
                                    {shareFeedback ? <Icon name="check" size={24} strokeWidth={3} /> : <Icon name="share-2" size={24} strokeWidth={3} />}
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Score Entry Overlay */}
                    {(isAddingRound || editingRoundIdx !== null) && (
                        <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-in fade-in">
                            <div className={`w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border animate-in slide-in-from-bottom-10 ${isDarkMode ? 'bg-slate-900 border-white/10' : 'bg-white border-slate-200'}`}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-black text-yellow-500 uppercase italic tracking-tight">{editingRoundIdx !== null ? `Fix Hand ${editingRoundIdx + 1}` : "Record Hand"}</h3>
                                    <button onClick={() => {setIsAddingRound(false); setEditingRoundIdx(null); setNewScores({});}} className="text-slate-500 p-2 btn-active"><Icon name="x" size={28} /></button>
                                </div>
                                {error && <div className="mb-4 bg-red-500/10 p-3 rounded-xl text-[10px] font-black text-red-500 uppercase flex items-center gap-2 animate-bounce"><Icon name="shield-alert" size={14}/> {error}</div>}
                                <div className="grid grid-cols-2 gap-4 mb-8 max-h-[40vh] overflow-y-auto pr-1 custom-scrollbar no-scrollbar">
                                    {players.map((_, idx) => !inactive.includes(idx) && (
                                        <div key={`entry-p-${idx}`} className="flex flex-col gap-2">
                                            <label className="text-[10px] font-black uppercase text-slate-500 mb-1 ml-2 truncate">{getPlayerName(idx)}</label>
                                            <input type="number" inputMode="numeric" value={newScores[getPlayerName(idx)] || ''} onChange={e => setNewScores({...newScores, [getPlayerName(idx)]: e.target.value})} className="w-full bg-slate-950/50 p-5 rounded-2xl text-center text-3xl font-black outline-none border border-white/5 text-yellow-500 placeholder:text-slate-800" placeholder="0" />
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => handleScoreEntry(editingRoundIdx !== null)} className="w-full bg-yellow-600 py-6 rounded-3xl font-black uppercase shadow-xl text-black tracking-widest text-xs btn-active transition-all">Confirm Hand</button>
                            </div>
                        </div>
                    )}

                    {/* Registry Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-in fade-in">
                            <div className={`w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl border ${isDarkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900 border-slate-200'}`}>
                                <h3 className="text-xl font-black text-yellow-500 uppercase mb-8 flex items-center gap-3"><Icon name="users" /> Registry</h3>
                                <input type="text" value={newPlayerName} onChange={e => setNewPlayerName(e.target.value)} placeholder="Member Name" className="w-full bg-slate-950/50 p-5 rounded-2xl mb-4 font-bold outline-none border border-white/5 text-indigo-400 placeholder:text-slate-700" />
                                <div className="grid grid-cols-2 gap-2 mb-8">
                                    <button onClick={() => addPlayer(false)} className="py-4 bg-slate-800 text-white rounded-2xl text-[10px] font-black uppercase border border-white/10 btn-active transition-all">Standard</button>
                                    <button onClick={() => addPlayer(true)} className="py-4 bg-yellow-600 text-black rounded-2xl text-[10px] font-black uppercase shadow-lg btn-active transition-all">Join @ Max+1</button>
                                </div>
                                <div className="space-y-2 mb-8 max-h-48 overflow-y-auto no-scrollbar custom-scrollbar">
                                    {players.map((_, i) => (
                                        <div key={`registry-p-${i}`} className="flex items-center justify-between p-4 glass-panel rounded-2xl">
                                            {editIdx === i ? (
                                                <div className="flex-1 flex gap-2">
                                                    <input type="text" value={editValue} onChange={e => setEditValue(e.target.value)} className="flex-1 bg-black/40 px-3 py-1 rounded text-[10px] font-black uppercase outline-none text-yellow-500" autoFocus />
                                                    <button onClick={() => savePlayerNameEdit(i)} className="text-yellow-500 btn-active"><Icon name="check-circle-2" size={18}/></button>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="flex items-center gap-3 truncate">
                                                        <span className="text-[10px] font-black uppercase truncate text-slate-300">{getPlayerName(i)}</span>
                                                        {reEntries[i] > 0 && <span className="bg-indigo-600 text-white text-[7px] px-1.5 rounded font-black leading-none py-1 whitespace-nowrap">R{reEntries[i]}</span>}
                                                    </div>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => { setEditIdx(i); setEditValue(getPlayerName(i)); }} className="text-indigo-400/60 p-2 btn-active"><Icon name="pencil" size={16}/></button>
                                                        <button onClick={() => removePlayer(i)} className="text-red-500 p-2 btn-active"><Icon name="user-minus" size={18}/></button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => setIsSettingsOpen(false)} className="w-full py-5 bg-slate-950 text-white rounded-2xl font-black uppercase tracking-widest text-xs btn-active border border-white/5">Close</button>
                            </div>
                        </div>
                    )}

                    {/* History Modal */}
                    {isHistoryOpen && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-in fade-in">
                            <div className={`w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border ${isDarkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900 border-slate-200'}`}>
                                <h3 className="text-xl font-black text-indigo-400 uppercase mb-6 flex items-center gap-3"><Icon name="history" /> Archive</h3>
                                <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-1 no-scrollbar custom-scrollbar">
                                    {sessionHistory.length === 0 ? (
                                        <div className="py-20 text-center opacity-20 text-xs font-black uppercase italic tracking-widest">Empty log</div>
                                    ) : (
                                        sessionHistory.map((log, hIdx) => (
                                            <div key={`history-match-${log.id}`} className="p-4 rounded-2xl glass-panel relative border border-white/5 shadow-inner">
                                                <div className="flex justify-between items-center mb-3 pb-2 border-b border-white/5">
                                                    <span className="text-[10px] font-black text-yellow-500 uppercase">{log.date}</span>
                                                    <span className="text-[8px] font-bold text-slate-600 uppercase tracking-widest">SESSION #{sessionHistory.length - hIdx}</span>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    {log.players.map((pName, pIdx) => {
                                                        const win = log.finalScores[pIdx] === Math.min(...log.finalScores);
                                                        return (
                                                            <div key={`hist-${log.id}-${pIdx}`} className="flex items-center justify-between text-[10px] bg-slate-950/50 p-2 rounded-lg border border-white/5">
                                                                <div className="flex items-center gap-1 truncate">
                                                                    {win && <Icon name="trophy" size={10} className="text-yellow-500" fill="#eab308" />}
                                                                    <span className={`font-black uppercase truncate ${win ? 'text-yellow-500' : 'text-slate-500'}`}>{pName}</span>
                                                                </div>
                                                                <span className="font-mono font-bold text-indigo-400">{log.finalScores[pIdx]}</span>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                                <button onClick={() => setIsHistoryOpen(false)} className="w-full mt-8 py-5 bg-slate-950 text-white rounded-2xl font-black uppercase tracking-widest text-xs btn-active border border-white/5 text-yellow-500">Back</button>
                            </div>
                        </div>
                    )}

                    {/* Bust / Rejoin Decision Overlay */}
                    {bustedOverlay && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl animate-in fade-in">
                            <div className={`w-full max-sm rounded-[2.5rem] p-8 shadow-2xl border ${isDarkMode ? 'bg-slate-900 text-white' : 'bg-white'}`}>
                                <div className="text-center mb-8">
                                    <div className={`w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 border-4 ${canRejoin ? 'bg-yellow-500/10 border-yellow-500/30 text-yellow-500 shadow-[0_0_20px_rgba(234,179,8,0.2)]' : 'bg-slate-500/10 border-slate-500/30 text-slate-500'}`}>
                                        <Icon name={canRejoin ? "stars" : "door-closed"} size={40} strokeWidth={2.5}/>
                                    </div>
                                    <h3 className="text-2xl font-black text-yellow-500 uppercase italic leading-none mb-4 gold-glow">{canRejoin ? "Bust Alert!" : "Locked Out"}</h3>
                                    <p className="text-[11px] font-bold uppercase text-slate-400 px-2 leading-relaxed tracking-tight">
                                        {getPlayerName(bustedOverlay.currentIdx)} passed 201. <br/>
                                        {canRejoin ? `Re-buy handicap entry at ${bustedOverlay.target}?` : "Locked. Opponent at 180+ prohibits re-entry."}
                                    </p>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => handleBustChoice(true)} disabled={!canRejoin} className={`py-5 rounded-2xl text-[10px] font-black uppercase shadow-xl transition-all ${!canRejoin ? 'bg-slate-800 text-slate-600 opacity-20 cursor-not-allowed' : 'bg-emerald-600 text-white btn-active'}`}>Re-entry</button>
                                    <button onClick={() => handleBustChoice(false)} className="bg-rose-700 py-5 rounded-2xl text-[10px] font-black uppercase text-white shadow-xl btn-active transition-all tracking-widest">Stay Out</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Generic Confirmation Modal */}
                    {confirmModal && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl animate-in fade-in">
                            <div className="w-full max-w-xs rounded-[2rem] p-8 glass-panel border border-white/10 text-center shadow-2xl">
                                <Icon name="alert-triangle" size={32} className="text-yellow-500 mb-4 mx-auto" />
                                <p className="text-sm font-black uppercase text-slate-200 mb-8 leading-tight tracking-tight">{confirmModal.message}</p>
                                <div className="flex gap-2">
                                    <button onClick={confirmModal.onConfirm} className="flex-1 py-4 bg-yellow-600 text-black rounded-xl text-[10px] font-black uppercase btn-active transition-all">Proceed</button>
                                    <button onClick={() => setConfirmModal(null)} className="flex-1 py-4 bg-slate-800 text-white rounded-xl text-[10px] font-black uppercase btn-active transition-all">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>