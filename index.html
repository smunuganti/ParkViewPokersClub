<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    
    <!-- App Meta & Standalone Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Poker 2026">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#020617">
    
    <!-- Festive Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23020617%22/><text y=%22.9em%22 font-size=%2280%22 x=%2210%22>ðŸŽ†</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ†</text></svg>">

    <title>Park View Pokers Club - Final 2026 Build</title>
    
    <!-- Core Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* CELEBRATION & GAME ANIMATIONS */
        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        @keyframes card-fall {
            0% { transform: translateY(-15vh) rotate(0deg) translateX(0); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(105vh) rotate(720deg) translateX(20px); opacity: 0; }
        }
        @keyframes spark-float {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0); opacity: 0; }
        }
        @keyframes rocket-soar {
            0% { transform: translateY(100vh) scale(1.2); opacity: 1; }
            75% { opacity: 1; }
            100% { transform: translateY(var(--target-y)) scale(0.5); opacity: 0; }
        }
        @keyframes explosion-pop {
            0% { transform: scale(0); opacity: 1; }
            50% { opacity: 1; }
            100% { transform: scale(5); opacity: 0; }
        }
        @keyframes bit-drift {
            0% { transform: translate(0, 0); opacity: 1; }
            100% { transform: translate(var(--p-x), var(--p-y)); opacity: 0; }
        }
        @keyframes glow-pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; filter: blur(1px); }
            50% { transform: scale(1.1); opacity: 1; filter: blur(0px); }
        }

        .animate-confetti { animation: confetti-fall linear infinite; }
        .animate-cards { animation: card-fall linear infinite; }
        .animate-spark { animation: spark-float 1.5s infinite linear; }
        .animate-rocket { animation: rocket-soar linear infinite; }
        .animate-pop { animation: explosion-pop ease-out infinite; }
        .animate-bit { animation: bit-drift ease-out infinite; }
        .animate-glow { animation: glow-pulse 2s infinite ease-in-out; }

        ::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body {
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            user-select: none;
            height: 100vh;
            width: 100vw;
            transition: background-color 0.5s ease;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-active:active { transform: scale(0.96); }
        input { user-select: text; }
        
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        .gold-glow {
            text-shadow: 0 0 15px rgba(253, 224, 71, 0.6);
        }
    </style>
</head>
<body id="app-body">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && window.lucide) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}" style="width:${size}px;height:${size}px;"></i>`;
                    window.lucide.createIcons({ targets: [containerRef.current] });
                }
            }, [name, size]);
            return <span ref={containerRef} className={`inline-flex items-center justify-center shrink-0 ${className}`} style={{ width: size, height: size }}></span>;
        };

        const STORAGE_KEY = "pvp_master_2026_final_v173";
        const THEME_KEY = "pvp_theme_2026_pref";
        const DEFAULT_ROSTER = ['Player 1', 'Player 2', 'Player 3'];

        // --- Celebration Visual Components ---

        const CountdownTimer = ({ isDarkMode }) => {
            const [timeLeft, setTimeLeft] = useState({ h: 0, m: 0, s: 0, finished: false });

            useEffect(() => {
                const targetDate = new Date("2026-01-01T00:00:00").getTime();
                const timer = setInterval(() => {
                    const now = new Date().getTime();
                    const diff = targetDate - now;

                    if (diff <= 0) {
                        setTimeLeft({ h: 0, m: 0, s: 0, finished: true });
                        clearInterval(timer);
                    } else {
                        const h = Math.floor(diff / (1000 * 60 * 60));
                        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const s = Math.floor((diff % (1000 * 60)) / 1000);
                        setTimeLeft({ h, m, s, finished: false });
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            if (timeLeft.finished) {
                return (
                    <div className="flex flex-col items-center mb-6 relative z-20">
                        <div className={`${isDarkMode ? 'bg-yellow-600/30 text-yellow-400 border-yellow-500/30' : 'bg-orange-500 text-white border-orange-400'} backdrop-blur-md px-10 py-2 rounded-full text-xs font-black uppercase tracking-[0.2em] inline-block border shadow-2xl animate-pulse`}>
                            Happy New Year 2026
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col items-center mb-10 relative z-20">
                    <div className="text-[10px] font-black uppercase tracking-[0.3em] mb-3 opacity-50">Counting Down to 2026</div>
                    <div className="flex gap-4">
                        {[
                            { label: 'Hrs', value: timeLeft.h },
                            { label: 'Min', value: timeLeft.m },
                            { label: 'Sec', value: timeLeft.s }
                        ].map((unit, i) => (
                            <div key={i} className="flex flex-col items-center">
                                <div className={`text-4xl font-black tabular-nums tracking-tighter ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>
                                    {String(unit.value).padStart(2, '0')}
                                </div>
                                <div className="text-[8px] font-bold uppercase tracking-widest opacity-40">{unit.label}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const RocketBlasts = () => {
            const rockets = useMemo(() => {
                const colors = ['#fde047', '#fb7185', '#34d399', '#38bdf8', '#a78bfa'];
                return Array.from({ length: 4 }).map((_, i) => ({
                    id: i, left: 15 + i * 23, targetY: 12 + Math.random() * 25 + 'vh',
                    duration: 2.2 + Math.random() * 1.5, delay: Math.random() * 5,
                    color: colors[i % colors.length]
                }));
            }, []);

            return (
                <div className="fixed inset-0 pointer-events-none z-30">
                    {rockets.map(r => (
                        <div key={r.id} className="absolute inset-0">
                            <div className="absolute animate-rocket w-0.5 h-12 rounded-full blur-[1px]"
                                 style={{ left: `${r.left}%`, backgroundColor: r.color, '--target-y': r.targetY, animationDuration: `${r.duration}s`, animationDelay: `${r.delay}s`, boxShadow: `0 0 10px ${r.color}` }}>
                                <div className="absolute top-full left-1/2 -translate-x-1/2 w-4 h-16 opacity-40"
                                     style={{ background: `linear-gradient(to bottom, ${r.color}, transparent)` }}></div>
                            </div>
                            <div className="absolute" style={{ left: `${r.left}%`, top: r.targetY }}>
                                <div className="absolute -translate-x-1/2 -translate-y-1/2 w-16 h-16 rounded-full bg-yellow-400 blur-xl animate-pop opacity-0"
                                     style={{ backgroundColor: r.color, animationDuration: `${r.duration}s`, animationDelay: `${r.delay + r.duration * 0.75}s` }}></div>
                                {[...Array(12)].map((_, pi) => (
                                    <div key={pi} className="absolute w-1.5 h-1.5 rounded-full bg-orange-400 animate-bit opacity-0"
                                         style={{ 
                                            backgroundColor: r.color,
                                            boxShadow: `0 0 8px ${r.color}`,
                                            '--p-x': `${(Math.random() - 0.5) * 220}px`, 
                                            '--p-y': `${(Math.random() - 0.5) * 220}px`, 
                                            animationDuration: `${r.duration}s`, 
                                            animationDelay: `${r.delay + r.duration * 0.75}s` 
                                        }}></div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const CardRain = ({ isDarkMode }) => {
            const symbols = useMemo(() => {
                const icons = ['spade', 'heart', 'diamond', 'club'];
                return Array.from({ length: 40 }).map((_, i) => {
                    const name = icons[i % 4];
                    let color = isDarkMode ? '#fde047' : '#f59e0b';
                    if (name === 'heart' || name === 'diamond') color = '#ef4444';
                    return {
                        id: i, name, color,
                        left: Math.random() * 100,
                        size: 16 + Math.random() * 14,
                        duration: 6 + Math.random() * 9,
                        delay: Math.random() * 12
                    };
                });
            }, [isDarkMode]);

            return (
                <div className="fixed inset-0 pointer-events-none overflow-hidden z-10">
                    {symbols.map(s => (
                        <div key={s.id} className="absolute animate-cards" 
                             style={{ left: `${s.left}%`, animationDuration: `${s.duration}s`, animationDelay: `${s.delay}s`, color: s.color }}>
                            <Icon name={s.name} size={s.size} />
                        </div>
                    ))}
                </div>
            );
        };

        const CelebrationSky = ({ isDarkMode }) => {
            const items = useMemo(() => {
                const colors = isDarkMode ? ['#fde047', '#ffffff', '#ca8a04'] : ['#f87171', '#60a5fa', '#34d399'];
                return Array.from({ length: 30 }).map((_, i) => ({
                    id: i, color: colors[i % colors.length], left: Math.random() * 100,
                    size: 3, dur: 5 + Math.random() * 6, del: Math.random() * 6
                }));
            }, [isDarkMode]);
            return (
                <div className="fixed inset-0 pointer-events-none overflow-hidden z-0">
                    {items.map(c => (
                        <div key={c.id} className="absolute animate-confetti" style={{ left: `${c.left}%`, backgroundColor: c.color, width: c.size, height: c.size, animationDuration: `${c.dur}s`, animationDelay: `${c.del}s`, borderRadius: '50%' }}></div>
                    ))}
                </div>
            );
        };

        const FireworksDisplay = ({ isDarkMode }) => (
            <div className="relative w-64 h-64 mx-auto mb-6 flex items-center justify-center overflow-hidden">
                <div className={`absolute inset-0 rounded-full blur-[60px] opacity-20 ${isDarkMode ? 'bg-yellow-500' : 'bg-orange-500'}`}></div>
                <div className="relative z-20 flex flex-col items-center animate-glow">
                    <div className={`text-7xl font-black italic tracking-tighter ${isDarkMode ? 'text-yellow-400 gold-glow' : 'text-orange-600'} drop-shadow-2xl`}>2026</div>
                    <div className={`text-[10px] font-black uppercase tracking-[0.4em] mt-[-8px] ${isDarkMode ? 'text-white/60' : 'text-slate-500'}`}>Club Official</div>
                </div>
                {[...Array(12)].map((_, i) => (
                    <div key={i} className={`absolute w-1 h-1 rounded-full animate-spark ${isDarkMode ? 'bg-yellow-300' : 'bg-orange-400'}`}
                         style={{ left: `${20 + Math.random() * 60}%`, top: `${40 + Math.random() * 40}%`, animationDelay: `${Math.random() * 2}s` }}></div>
                ))}
            </div>
        );

        // --- Main App Logic ---

        const App = () => {
            const [showWelcome, setShowWelcome] = useState(true);
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const saved = localStorage.getItem(THEME_KEY);
                return saved === null ? true : saved === 'true';
            });

            const [game, setGame] = useState(() => {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) return JSON.parse(data);
                return { players: DEFAULT_ROSTER, rounds: [], history: [], inactive: [], reEntries: new Array(DEFAULT_ROSTER.length).fill(0) };
            });

            const [ui, setUi] = useState({ add: false, editIdx: null, settings: false, history: false, bust: null, confirm: null });
            const [form, setForm] = useState({ scores: {}, name: '', editIdx: null, editVal: '', error: null });
            const scrollRef = useRef(null);

            const players = game.players;
            const rounds = game.rounds;
            const inactive = game.inactive || [];
            const reEntries = game.reEntries || new Array(players.length).fill(0);
            const sessionHistory = game.history || [];

            const totals = useMemo(() => players.map((_, pIdx) => rounds.reduce((sum, r) => sum + (Array.isArray(r) ? (r[pIdx] || 0) : 0), 0)), [players, rounds]);
            const activeTotals = useMemo(() => totals.filter((_, i) => !inactive.includes(i)), [totals, inactive]);
            const leaderIdx = useMemo(() => rounds.length === 0 ? -1 : totals.findIndex((t, i) => !inactive.includes(i) && t === Math.min(...activeTotals)), [totals, inactive, activeTotals, rounds]);
            const matchOver = (players.length - inactive.length) <= 1 && rounds.length > 0;

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(game));
                localStorage.setItem(THEME_KEY, isDarkMode.toString());
                document.body.style.backgroundColor = isDarkMode ? "#020617" : "#f1f5f9";
            }, [game, isDarkMode]);

            useEffect(() => {
                if (!showWelcome && scrollRef.current && game.rounds.length > 0) {
                    scrollRef.current.scrollTo({ top: scrollRef.current.scrollHeight, behavior: 'smooth' });
                }
            }, [game.rounds, showWelcome]);

            const submitScores = (isEditing = false) => {
                setForm(f => ({ ...f, error: null }));
                const entry = players.map((p, i) => inactive.includes(i) ? 0 : parseInt(form.scores[p] || 0));
                if (entry.filter((s, i) => !inactive.includes(i) && s === 0).length !== 1) {
                    setForm(f => ({ ...f, error: "Missing score or multiple winners (0)." })); return;
                }
                if (isEditing) {
                    const up = [...rounds]; up[ui.editIdx] = entry;
                    setGame(g => ({ ...g, rounds: up }));
                    setUi(u => ({ ...u, editIdx: null })); setForm(f => ({ ...f, scores: {} }));
                } else {
                    const proj = totals.map((t, i) => t + (entry[i] || 0));
                    const busted = proj.map((t, i) => (!inactive.includes(i) && t > 201) ? i : -1).filter(i => i !== -1);
                    if (busted.length > 0) {
                        const others = proj.filter((t, i) => !busted.includes(i) && !inactive.includes(i));
                        const target = (others.length > 0 ? Math.max(...others) : 0) + 1;
                        setUi(u => ({ ...u, bust: { idxs: busted, current: busted[0], target, pending: entry, proj } }));
                    } else {
                        setGame(g => ({ ...g, rounds: [...g.rounds, entry] }));
                        setUi(u => ({ ...u, add: false })); setForm(f => ({ ...f, scores: {} }));
                    }
                }
            };

            const solveBust = (rejoin) => {
                const scores = [...ui.bust.pending];
                const pIdx = ui.bust.current;
                const locked = ui.bust.proj.some((t, i) => i !== pIdx && !inactive.includes(i) && t >= 180);
                let upIn = [...inactive]; let upRe = [...reEntries];
                if (rejoin && !locked) {
                    scores[pIdx] = ui.bust.target - totals[pIdx];
                    upRe[pIdx] = (upRe[pIdx] || 0) + 1;
                } else if (!upIn.includes(pIdx)) upIn.push(pIdx);
                const next = ui.bust.idxs.filter(i => i !== pIdx);
                if (next.length === 0) {
                    setGame(g => ({ ...g, inactive: upIn, reEntries: upRe, rounds: [...g.rounds, scores] }));
                    setUi(u => ({ ...u, bust: null, add: false })); setForm(f => ({ ...f, scores: {} }));
                } else setUi(u => ({ ...u, bust: { ...u.bust, current: next[0], idxs: next, pending: scores } }));
            };

            const midGameJoin = () => {
                if(!form.name.trim()) return;
                const currentHighest = activeTotals.length > 0 ? Math.max(...activeTotals) : 0;
                setGame(g => ({
                    ...g, players: [...g.players, form.name.trim()], reEntries: [...g.reEntries, 0],
                    rounds: g.rounds.map((r, i) => i === 0 ? [...r, currentHighest + 1] : [...r, 0])
                }));
                setForm(f => ({ ...f, name: '' }));
            };

            const savePlayerNameEdit = (idx) => {
                if (!form.editVal.trim()) return;
                const updatedPlayers = [...players];
                updatedPlayers[idx] = form.editVal.trim();
                setGame(prev => ({ ...prev, players: updatedPlayers }));
                setForm(f => ({ ...f, editIdx: null, editVal: '' }));
            };

            const confirmReset = () => {
                setUi(u => ({ ...u, confirm: { msg: "Archive session and reset all scores to 0?", fn: () => {
                    const summary = { id: Date.now(), ts: Date.now(), date: new Date().toLocaleString(), players: [...players], finalScores: [...totals] };
                    setGame(prev => ({ ...prev, rounds: [], inactive: [], reEntries: new Array(prev.players.length).fill(0), history: [summary, ...(prev.history || [])].slice(0, 5) }));
                    setUi(prevUi => ({ ...prevUi, confirm: null }));
                }}}));
            };

            if (showWelcome) {
                return (
                    <div className={`fixed inset-0 flex flex-col items-center justify-center p-8 transition-colors duration-500 overflow-hidden ${isDarkMode ? 'bg-[#020617] text-white' : 'bg-slate-50 text-slate-900'}`}>
                        {isDarkMode && <div className="absolute inset-0 z-0"><img src="image.png" alt="" className="w-full h-full object-cover opacity-50" onError={(e) => e.target.style.display = 'none'} /><div className="absolute inset-0 bg-gradient-to-t from-[#020617] via-[#020617]/70 to-transparent"></div></div>}
                        <CelebrationSky isDarkMode={isDarkMode} />
                        <CardRain isDarkMode={isDarkMode} />
                        <RocketBlasts />
                        <div className="max-w-sm w-full text-center relative z-10">
                            <CountdownTimer isDarkMode={isDarkMode} />
                            <FireworksDisplay isDarkMode={isDarkMode} />
                            <h1 className={`text-3xl font-black uppercase italic mb-1 ${isDarkMode ? 'text-yellow-500' : 'text-orange-600'}`}>Park View Pokers</h1>
                            <h2 className={`text-5xl font-black uppercase tracking-widest mb-12 ${isDarkMode ? 'text-slate-300' : 'text-slate-500'}`}>Club</h2>
                            <div className="flex gap-2">
                                <button onClick={() => setShowWelcome(false)} className={`flex-1 h-16 rounded-3xl font-black uppercase tracking-widest shadow-2xl transition-all btn-active ${isDarkMode ? 'bg-orange-600' : 'bg-orange-500 text-white'}`}>Open Match</button>
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className={`w-16 h-16 rounded-3xl flex items-center justify-center shadow-2xl btn-active ${isDarkMode ? 'bg-slate-800 text-yellow-400' : 'bg-white border'}`}><Icon name={isDarkMode ? "sun" : "moon"} /></button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`fixed inset-0 flex flex-col transition-colors duration-500 overflow-hidden ${isDarkMode ? 'bg-[#020617] text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
                    <CelebrationSky isDarkMode={isDarkMode} />
                    <CardRain isDarkMode={isDarkMode} />
                    
                    <nav className={`flex-none px-4 py-4 z-40 pt-safe border-b backdrop-blur-xl ${isDarkMode ? 'bg-slate-900/70 border-white/10' : 'bg-white/90 border-slate-200'}`}>
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowWelcome(true)} className={`w-10 h-10 rounded-2xl flex items-center justify-center text-white shadow-lg btn-active ${isDarkMode ? 'bg-orange-500' : 'bg-orange-600'}`}><Icon name="home" /></button>
                                <div className="text-left leading-none"><h1 className={`text-[11px] font-black uppercase tracking-tight ${isDarkMode ? 'text-yellow-400' : 'text-orange-600'}`}>PV Pokers</h1><span className="text-[9px] font-bold uppercase opacity-80">2026 Session</span></div>
                            </div>
                            <div className="flex items-center gap-1">
                                <button onClick={confirmReset} className="p-2 opacity-70 hover:opacity-100 text-white btn-active" title="Reset Session"><Icon name="rotate-ccw" /></button>
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 opacity-70 btn-active transition-colors"><Icon name={isDarkMode ? "sun" : "moon"} /></button>
                                <button onClick={() => setUi({...ui, history: true})} className="p-2 opacity-70 btn-active transition-colors"><Icon name="history" /></button>
                                <button onClick={() => setUi({...ui, settings: true})} className="p-2 opacity-70 btn-active transition-colors"><Icon name="settings-2" /></button>
                            </div>
                        </div>
                    </nav>

                    <div className="flex-1 flex flex-col overflow-hidden relative">
                        <div className={`flex-none flex border-b-2 z-20 ${isDarkMode ? 'bg-slate-950 border-white/10 shadow-lg' : 'bg-slate-100 shadow-sm'}`}>
                            <div className="w-10 text-[8px] font-black flex items-center justify-center italic text-slate-500">Hand</div>
                            <div className="flex-1 flex">
                                {players.map((p, i) => (
                                    <div key={i} className={`flex-1 border-r last:border-r-0 py-3 text-center truncate ${inactive.includes(i) ? 'opacity-30 grayscale bg-black/5' : ''}`}>
                                        <div className="flex flex-col items-center justify-center px-0.5 min-w-0">
                                            <span className={`text-[10px] font-black uppercase truncate block w-full tracking-tight ${isDarkMode ? 'text-yellow-500' : 'text-orange-700'}`}>{p}</span>
                                            {reEntries[i] > 0 && <span className="bg-indigo-600 text-white text-[6px] px-1 rounded-sm leading-none py-1">R{reEntries[i]}</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div ref={scrollRef} className="flex-1 overflow-y-auto no-scrollbar bg-black/5">
                            {rounds.map((round, rIdx) => (
                                <div key={rIdx} className={`flex border-b transition-colors ${isDarkMode ? 'border-white/5 hover:bg-white/5' : 'border-slate-200 hover:bg-white'}`}>
                                    <div className="w-10 flex flex-col items-center justify-center py-4"><span className="text-[10px] font-bold text-slate-500">{rIdx + 1}</span><button onClick={() => { setUi({...ui, editIdx: rIdx}); const c = {}; players.forEach(p => c[p] = round[players.indexOf(p)]); setForm({...form, scores: c}); }} className="text-orange-500/40 mt-1"><Icon name="pencil-line" size={12} /></button></div>
                                    <div className="flex-1 flex">{round.map((score, cIdx) => (<div key={cIdx} className={`flex-1 border-r last:border-r-0 flex items-center justify-center py-4 ${inactive.includes(cIdx) ? 'opacity-10' : ''}`}>{score === 0 ? <span className="w-7 h-7 rounded-full bg-orange-600 text-white flex items-center justify-center text-[10px] font-black shadow-lg">0</span> : <span className="text-sm font-bold tabular-nums">{score}</span>}</div>))}</div>
                                </div>
                            ))}
                        </div>
                        <div className={`flex-none flex text-white shadow-[0_-10px_30px_rgba(0,0,0,0.3)] z-30 ${isDarkMode ? 'bg-slate-900 border-t border-white/10' : 'bg-slate-800'}`}>
                            <div className="w-10 flex items-center justify-center text-[8px] font-black italic bg-black/20 text-slate-500 uppercase">Total</div>
                            <div className="flex-1 flex">
                                {totals.map((total, i) => (
                                    <div key={i} className={`flex-1 py-4 border-r last:border-r-0 border-white/5 text-center font-black text-lg min-w-0 ${inactive.includes(i) ? 'opacity-50 line-through' : ''}`}>
                                        <span className="flex items-center justify-center gap-1">{total} {i === leaderIdx && !inactive.includes(i) && rounds.length > 0 && <Icon name="crown" size={14} className="text-yellow-400 animate-bounce" />}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className={`p-5 pb-safe flex-none border-t ${isDarkMode ? 'bg-slate-900/95 border-white/10' : 'bg-white border-slate-200'}`}>
                        {matchOver ? (
                            <div className="text-center p-2 animate-in zoom-in-95 duration-500"><h4 className="text-xl font-black italic text-orange-500 uppercase mb-3 drop-shadow-xl">Winner Found!</h4><button onClick={confirmReset} className="px-10 py-4 bg-orange-600 text-white rounded-full text-xs font-black uppercase active:scale-95 transition-all shadow-xl">New Match</button></div>
                        ) : (
                            <div className="flex gap-2 max-w-lg mx-auto">
                                <button onClick={() => setUi({...ui, add: true})} className="flex-1 h-16 bg-orange-600 text-white rounded-3xl font-black uppercase tracking-widest shadow-xl flex items-center justify-center gap-3 btn-active transition-all"><Icon name="plus" size={24} /> Record Hand</button>
                                <button onClick={() => {
                                    const text = `ðŸª PV Pokers 2026 ðŸª\n\n` + players.map((p, i) => `${p}: ${totals[i]}${reEntries[i] > 0 ? ` (R${reEntries[i]})` : ''}${inactive.includes(i) ? ' (Out)' : ''}`).join('\n');
                                    if(navigator.share) navigator.share({text}); else { const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); setUi(u=>({...u, confirm: {msg: "Scores copied!", fn: () => setUi(us=>({...us, confirm: null})) } })); }
                                }} className={`px-6 h-16 rounded-2xl font-black shadow-xl flex items-center justify-center btn-active transition-all ${isDarkMode ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-white'}`}>
                                    <Icon name="share-2" size={24} />
                                </button>
                            </div>
                        )}
                    </div>

                    {/* OVERLAYS SYSTEM */}
                    {(ui.add || ui.editIdx !== null || ui.settings || ui.history || ui.bust || ui.confirm) && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-in fade-in">
                            
                            {(ui.add || ui.editIdx !== null) && (
                                <div className={`w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border animate-in slide-in-from-bottom-10 ${isDarkMode ? 'bg-slate-900 border-white/10 text-white' : 'bg-white border-slate-200 text-slate-900'}`}>
                                    <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-black text-orange-500 uppercase italic tracking-tight">{ui.editIdx !== null ? "Edit Scores" : "Hand Result"}</h3><button onClick={() => setUi({...ui, add: false, editIdx: null})} className="text-slate-500 p-2"><Icon name="x" size={28} /></button></div>
                                    {form.error && <div className="mb-4 bg-red-500/10 p-3 rounded-xl text-[10px] font-black text-red-500 uppercase animate-bounce">{form.error}</div>}
                                    <div className="grid grid-cols-2 gap-4 mb-8 max-h-[40vh] overflow-y-auto pr-1 no-scrollbar">{players.map((p, idx) => !inactive.includes(idx) && (<div key={idx} className="flex flex-col gap-2"><label className="text-[10px] font-black uppercase text-slate-500 truncate tracking-tighter">{p}</label><input type="number" inputMode="numeric" value={form.scores[p] || ''} onChange={e => setForm({...form, scores: {...form.scores, [p]: e.target.value}})} className={`w-full p-5 rounded-2xl text-center text-3xl font-black outline-none border ${isDarkMode ? 'bg-slate-950/50 border-white/5 text-orange-500' : 'bg-slate-50 border-slate-200'}`} placeholder="0" /></div>))}</div>
                                    <button onClick={() => submitScores(ui.editIdx !== null)} className="w-full bg-orange-600 py-6 rounded-3xl font-black uppercase shadow-xl text-white tracking-widest text-xs btn-active">Confirm Hand</button>
                                </div>
                            )}

                            {ui.settings && (
                                <div className={`w-full max-sm rounded-[2.5rem] p-8 shadow-2xl border ${isDarkMode ? 'bg-slate-900 border-white/10 text-white' : 'bg-white border-slate-200 text-slate-900'}`}>
                                    <h3 className="text-xl font-black text-orange-500 uppercase mb-8 flex items-center gap-3 tracking-tighter"><Icon name="users" /> 2026 Registry</h3>
                                    <input type="text" value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="New Member Name" className={`w-full p-5 rounded-2xl mb-4 font-bold outline-none border ${isDarkMode ? 'bg-slate-950 border-white/5 text-indigo-400' : 'bg-slate-50 border-slate-200 text-slate-900'}`} />
                                    <div className="grid grid-cols-2 gap-2 mb-8">
                                        <button onClick={() => { if(form.name) { setGame(g=>({...g, players: [...g.players, form.name.trim()], rounds: [], inactive: [], reEntries: new Array(g.players.length+1).fill(0)})); setForm(f=>({...f, name:''})); setUi(u=>({...u, settings: false})); }}} className={`py-4 rounded-2xl text-[10px] font-black uppercase border btn-active ${isDarkMode ? 'bg-slate-800' : 'bg-slate-100 shadow-sm'}`}>Reset Table</button>
                                        <button onClick={midGameJoin} className="py-4 bg-orange-600 text-white rounded-2xl text-[10px] font-black uppercase shadow-lg btn-active">Join @ Max+1</button>
                                    </div>
                                    <div className="space-y-2 mb-8 max-h-48 overflow-y-auto no-scrollbar">
                                        {players.map((p, i) => (
                                            <div key={i} className={`flex items-center justify-between p-4 rounded-2xl border ${isDarkMode ? 'bg-white/5 border-white/10' : 'bg-slate-50 border-slate-200'}`}>
                                                {form.editIdx === i ? (
                                                    <div className="flex-1 flex gap-2 min-w-0">
                                                        <input type="text" value={form.editVal} onChange={e => setForm({...form, editVal: e.target.value})} className="flex-1 bg-black/40 px-3 py-1 rounded text-[10px] font-black uppercase outline-none text-yellow-500 min-w-0" autoFocus />
                                                        <button onClick={() => savePlayerNameEdit(i)} className="text-yellow-500 shrink-0"><Icon name="check-circle-2" /></button>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <span className="text-[10px] font-black uppercase truncate max-w-[120px]">{p}</span>
                                                        <div className="flex gap-1 shrink-0">
                                                            <button onClick={() => setForm({...form, editIdx: i, editVal: p})} className="p-2 opacity-50"><Icon name="pencil" size={16}/></button>
                                                            <button onClick={() => { if(players.length > 2) setGame({...game, players: players.filter(pl => pl !== p), rounds: [], inactive: []}); }} className="text-red-500 p-2"><Icon name="user-minus" size={18}/></button>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={() => setUi({...ui, settings: false})} className="w-full py-5 bg-slate-950 text-white rounded-2xl font-black uppercase text-xs btn-active border border-white/5">Back</button>
                                </div>
                            )}

                            {ui.history && (
                                <div className={`w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border ${isDarkMode ? 'bg-slate-900 border-white/10 text-white' : 'bg-white border-slate-200 text-slate-900'}`}>
                                    <h3 className="text-xl font-black text-indigo-400 uppercase mb-6 flex items-center gap-3 tracking-tighter"><Icon name="history" /> History Log</h3>
                                    <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-1 no-scrollbar">
                                        {sessionHistory.length === 0 ? <div className="py-20 text-center opacity-20 text-xs font-black uppercase italic tracking-widest text-center">No Archives</div> : sessionHistory.map((log) => (<div key={log.id} className={`p-4 rounded-2xl border ${isDarkMode ? 'bg-black/20 border-white/5 shadow-inner' : 'bg-slate-100 border-slate-200'}`}><div className="flex justify-between mb-3 border-b border-white/5 pb-2 text-yellow-500 font-black tracking-widest"><span className="text-[10px]">{log.date}</span><button onClick={() => { if(confirm("Restore this archive? Current match will be replaced.")) { setGame(prev => ({...prev, players: log.players, rounds: log.rounds, inactive: [] })); setUi({...ui, history: false}); } }} className="text-[8px] bg-rose-600 text-white px-2 py-1 rounded font-black uppercase active:scale-90">Restore</button></div><div className="grid grid-cols-2 gap-2">{log.players.map((pName, pIdx) => (<div key={pIdx} className="flex items-center justify-between text-[10px] opacity-80 truncate"><span>{pName}</span><span className="font-bold">{log.finalScores[pIdx]}</span></div>))}</div></div>))}
                                    </div>
                                    <button onClick={() => setUi({...ui, history: false})} className="w-full mt-8 py-5 bg-slate-950 text-white rounded-2xl font-black uppercase text-xs btn-active border border-white/5">Close Log</button>
                                </div>
                            )}

                            {ui.bust && (
                                <div className={`w-full max-sm rounded-[2.5rem] p-8 shadow-2xl border ${isDarkMode ? 'bg-slate-900 text-white border-white/10' : 'bg-white border-slate-200 text-slate-900'}`}>
                                    <div className="text-center mb-8"><Icon name="wind" size={40} className="mb-4 text-orange-500"/><h3 className="text-2xl font-black uppercase italic mb-4 tracking-tighter leading-none">Bust Alert!</h3><p className="text-xs font-bold uppercase opacity-60 px-4 leading-relaxed tracking-tighter">
                                        {players[ui.bust.current]} passed 201. <br/>
                                        {ui.bust.proj.some((t, i) => i !== ui.bust.current && !inactive.includes(i) && t >= 180) ? "The Door is Closed. Player at 180+ prohibits re-entry." : `Re-buy handicap entry at ${ui.bust.target}?`}
                                    </p></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={() => solveBust(true)} disabled={ui.bust.proj.some((t, i) => i !== ui.bust.current && !inactive.includes(i) && t >= 180)} className={`py-5 rounded-2xl text-xs font-black uppercase shadow-xl transition-all ${ui.bust.proj.some((t, i) => i !== ui.bust.current && !inactive.includes(i) && t >= 180) ? 'bg-slate-800 text-slate-600 opacity-20' : 'bg-orange-600 text-white btn-active'}`}>Re-entry</button>
                                        <button onClick={() => solveBust(false)} className="bg-rose-700 py-5 text-white rounded-2xl text-xs font-black uppercase btn-active shadow-xl tracking-widest">Stay Out</button>
                                    </div>
                                </div>
                            )}

                            {ui.confirm && (
                                <div className="w-full max-w-xs rounded-[2.5rem] p-8 bg-slate-900 border border-white/10 text-center shadow-2xl animate-in zoom-in-95">
                                    <Icon name="alert-triangle" size={32} className="text-yellow-500 mb-4 mx-auto" />
                                    <p className="text-sm font-black uppercase text-slate-200 mb-8 leading-tight tracking-tight">{ui.confirm.msg}</p>
                                    <div className="flex gap-2">
                                        <button onClick={ui.confirm.fn} className="flex-1 py-4 bg-orange-600 text-white rounded-xl text-[10px] font-black uppercase btn-active">Yes</button>
                                        <button onClick={() => setUi({...ui, confirm: null})} className="flex-1 py-4 bg-slate-800 text-white rounded-xl text-[10px] font-black uppercase btn-active">No</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>